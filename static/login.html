<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Login</title>
    <link href="/assets/bootstrap-5.2.2-dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="row ms-3 me-3">
    <div class="mx-auto" style="max-width: 10cm;">
        <div class="row">
            <a class="mx-auto" style="width: auto;" href="/">
                <img class="m-3" src="/assets/img/logo.svg" alt="Logo" style="width: 2cm"/>
            </a>
            <h3 class="text-center">Bei FIDO Demo anmelden</h3>
            <div class="card pb-3">
                <div class="card-body">
                    Aus Sicherheitsgründen können Sie sich bei FIDO Demo nur mit einem FIDO-Sicherheitsschlüssel
                    anmelden.
                    <br>
                    Klicken Sie auf den Button, um die Authentifizierung zu starten.
                </div>

                <div id="authentication-inprogress-div" class="mb-3" style="display: none;">
                    <div class="d-flex justify-content-center mb-1 text-secondary">
                        <div class="spinner-border" role="status"></div>
                    </div>
                    <div class="text-center text-secondary">Warte auf Genehmigung...</div>
                </div>

                <div id="authentication-failed-alert" class="alert alert-danger text-center" style="display: none;"
                     role="alert">
                    <div class="fs-1">⚠</div>
                    <div>Anmeldung gescheitert</div>
                </div>

                <button id="authenticate-button" type="button" onclick="onAuthenticateButtonClicked()"
                        class="btn btn-primary">Sicherheitsschlüssel verwenden
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const authenticationInProgressDiv = document.getElementById("authentication-inprogress-div");
    const authenticationFailedAlert = document.getElementById("authentication-failed-alert");
    const authenticateButton = document.getElementById("authenticate-button");

    function displayAuthenticationFailure() {
        authenticationInProgressDiv.style.display = "none";
        authenticationFailedAlert.style.display = "block";
        authenticateButton.textContent = "Erneut versuchen";
        authenticateButton.style.display = "block";
    }

    function displayAuthenticationInProgress() {
        authenticationFailedAlert.style.display = "none";
        authenticationInProgressDiv.style.display = "block";
        authenticateButton.style.display = "none";
    }
</script>

<script type="module">
    import {
        get,
        parseRequestOptionsFromJSON,
    } from '/assets/js/webauthn-json.browser-ponyfill.js';

    async function onAuthenticateButtonClicked() {
        displayAuthenticationInProgress();

        let request = await fetch('/api/authenticate/begin', {
            method: 'POST',
        });
        if (!request.ok) {
            displayAuthenticationFailure();
            let errorMessage = "Failed to retrieve authentication data from the server. URL: " + request.url +
                " Status: " + request.status + " Response Body: " + await request.text();
            throw new Error(errorMessage);
        }
        let json = await request.json();
        let options = parseRequestOptionsFromJSON(json);

        let response = null;
        try {
            response = await get(options);
        } catch (e) {
            displayAuthenticationFailure();
            throw Error("The browser could not process the cryptographic challenge. The most likely cause is that the " +
                "user didn't allow the request. Raw Error: " + e)
        }

        let result = await fetch('/api/authenticate/complete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(response),
        });

        if (!result.ok) {
            displayAuthenticationFailure();
            let errorMessage = "The server rejected the signed challenge. URL: " + request.url +
                " Status: " + request.status + " Response Body: " + await request.text();
            throw new Error(errorMessage);
        }

        window.location = "/user.html"
    }

    window.onAuthenticateButtonClicked = onAuthenticateButtonClicked
</script>

<!--<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
        integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
        crossorigin="anonymous"></script>-->
<script src="/assets/bootstrap-5.2.2-dist/js/bootstrap.min.js"></script>
</body>
</html>
