{% extends "fido_layout.html" %}

{% block title %}Registrieren{% endblock %}

{% block fido_layout_card_title %}Bei FIDO Demo registrieren{% endblock %}

{% block fido_layout_card_text %}
    Aus Sicherheitsgründen können Sie sich bei FIDO Demo nur mit einem FIDO-Sicherheitsschlüssel
    registrieren.
    <br>
    Klicken Sie auf den Button, um die Authentifizierung zu starten.
{% endblock %}

{% block fido_layout_button %}
    <button id="authenticate-button" type="button" onclick="onAuthenticateButtonClicked()"
            class="btn btn-primary">Sicherheitsschlüssel verwenden
    </button>
{% endblock %}

{% block additional_scripts %}
    {{ super() }}

    <script>
        const authenticateButton = document.getElementById("authenticate-button");

        function displayFailure() {
            fidoLayout_displayFailure("Registrierung gescheitert");

            authenticateButton.innerText = "Erneut versuchen";
            authenticateButton.style.display = "block";
        }

        function displayInProgress() {
            fidoLayout_displayInProgress();
            authenticateButton.style.display = "none";
        }
    </script>

    <script type="module">
        import {
            create,
            parseCreationOptionsFromJSON,
        } from '/assets/js/webauthn-json.browser-ponyfill.js';

        async function onAuthenticateButtonClicked() {
            displayInProgress();

            let request = await fetch('/api/register/begin', {
                method: 'POST',
            });
            if (!request.ok) {
                displayFailure();
                let errorMessage = "Failed to retrieve registration data from the server. URL: " + request.url +
                    " Status: " + request.status + " Response Body: " + await request.text();
                throw new Error(errorMessage);
            }

            let json = await request.json();
            let options = parseCreationOptionsFromJSON(json);

            let response = null;
            try {
                response = await create(options);
            } catch (e) {
                displayFailure();
                throw Error("The browser could not process the cryptographic challenge. The most likely cause is that the " +
                    "user didn't allow the request. Raw Error: " + e)
            }

            let result = await fetch('/api/register/complete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(response),
            });

            if (!result.ok) {
                displayFailure();
                let errorMessage = "The server rejected the signed challenge. URL: " + request.url +
                    " Status: " + request.status + " Response Body: " + await request.text();
                throw new Error(errorMessage);
            }

            window.location = "/"
        }

        window.onAuthenticateButtonClicked = onAuthenticateButtonClicked;
    </script>

{% endblock %}
